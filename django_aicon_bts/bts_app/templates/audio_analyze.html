<!DOCTYPE html>
<html>
<head>
    <title>Image Generator</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <form id="image-form">
        {% csrf_token %}
        <input type="text" id="image-prompt" placeholder="Enter image prompt">
        <button type="submit">Generate Image</button>
    </form>
    
    <div id="you_may_enter" class="centered" style="display: none; color:gray;">
        <h1 class="display-2"><strong>you may enter</strong></h1>        
    </div>
    <div id="mic_recording" class="centered" style="display: none; color:gray;">
        <h1 class="display-2"><strong>you may speak</strong></h1>        
    </div>
    <div class="centered" id="micIcon" style="display: none; color:gray;">
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>
        <br/>   
        <br/>
        <br/>   
        <br/>
        <br/>     
        <br/>
        <br/>
        <br/>   
        <br/>
        <br/>   
        <br/>
        <br/>   
        <br/>     
        <br/>
        <br/>
        <br/>   
        <br/>
        <br/>   
        <br/>
        <br/> 
    <i class="fas fa-microphone fa-5x"></i>            

    </div>
    <!-- <div id="loading-transcription" class="bottom-centered" style="display: none;">
        <h3 class="display-4">Transcribing...</h3>
    </div> -->
    <div id="transcriptionResult" class="centered" style="display: none;">
        <!-- transcriptionText -->
        <p class="display-2" id="transcriptionText"></p>
    </div>
    <!-- <div id="loading-gpt-prompt" class="bottom-centered" style="display: none;">      
        <h3 class="display-4">Generating GPT prompt...</h3>
    </div> -->
    <!-- <div id="gptPromptResult" class="centered" style="display: none;">        
        <p class="display-4" id="gptPromptText"></p>
    </div> -->
    <div id="loading-image" class="bottom-centered" style="display: none;">
        <h3 class="display-6">generating image...</h3>        
    </div>
    <div id="profanity-detected" class="centered" style="display: none;">
        <h3 class="display-4">Profanity detected. Please try again.</h3>
    </div>
    <img id="generated-image" src="" class="centered" style="display: none;">

    <style>
        body {
            min-height: 100vh;
            margin: 0;
            font-family: 'Courier 10 Pitch', monospace;
            font-weight: bold;
        }

        .centered {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .bottom-centered {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        #generated-image {
            border-radius: 50%;
        }

        #transcriptionText:after {
            content: '|';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>



    <script>        
        document.addEventListener('DOMContentLoaded', () => {
        //     function getGptContextPrompt(speech2text) {

        //         $.ajax({
        //             url: '/get_gpt_context_prompt/',
        //             type: 'post',
        //             data: {
        //                 'result_speech2text': speech2text,
        //                 'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
        //             },
        //             success: function(data){
        //                 console.log(data);
        //                 console.log('GPT response received successfully');      
        //                 $('#gptPromptText').text(data);   
        //                 onGptPromptResultReady();
        //                 generateImage(data);
        //             }
        //         });
        //     }

            function generateImage(imagePrompt) {
                $.ajax({
                    url: '/generate_image/',
                    type: 'post',
                    data: {
                        'image_prompt': imagePrompt,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function(data){                        
                        if(data=="profanity_detected"){
                            $('#image-form, #mic_recording, #transcriptionResult, #loading-gpt-prompt, #gptPromptResult, #loading-image, #generated-image').hide();
                            $('#profanity-detected').show();
                            setTimeout(() => {
                                $('#profanity-detected').hide();
                                $('#mic_recording').show();
                                startRecording();
                            }, 4000);
                            return;
                        }
                        // $('#generated-image').attr('src', data);
                        // console.log(data);
                        // console.log('Image generated successfully');
                        // onImageGenerated();
                        $('#generated-image').one('load', function() {
                            console.log('Image loaded successfully');
                            onImageGenerated();
                        }).attr('src', data);
                        console.log(data);
                        console.log('Image src set successfully');
                    }
                });
            }

            $(document).ready(function(){  
                // Initially, hide all elements except the mic_recording
                $('#image-form, #profanity-detected, #transcriptionResult, #loading-gpt-prompt, #gptPromptResult, #loading-image, #generated-image').hide();
                $('#mic_recording').show();            
            });

            // When the transcription result is ready, show only the loading-gpt-prompt
            // You need to call this function when the transcription result is ready
            function onTranscriptionResultReady() {
                if($('#loading-image').is(':visible')){
                    return; //if the image is ready before the text is done with animation, don't show the gpt prompt
                }
                $('#mic_recording, #profanity-detected, #image-form, #loading-image, #generated-image').hide();
                //$('#transcriptionResult, #loading-gpt-prompt').show();
                $('#transcriptionResult, #loading-image').show();
            }

            // When the GPT prompt result is ready, show only the gptPromptResult and loading-image
            // You need to call this function when the GPT prompt result is ready
            function onGptPromptResultReady() {
                $('#mic_recording, #profanity-detected, #image-form, #transcriptionResult, #loading-gpt-prompt, #generated-image').hide();
                $('#gptPromptResult, #loading-image').show();
            }

            // When the image is generated, show only the generated image
            // You need to call this function when the image is generated
            function onImageGenerated() {
                $('#mic_recording, #image-form, #profanity-detected, #transcriptionResult, #loading-gpt-prompt, #gptPromptResult, #loading-image').hide();
                $('#generated-image').show();

                setTimeout(function() {
                    $('#generated-image').animate({
                        width: '0px',
                        height: '0px'
                    }, 2000, function() {
                        $('#you_may_enter').show();
                        setTimeout(function() {
                            $('#mic_recording').show();
                            $('#you_may_enter').hide();
                            $('#generated-image').hide();
                            startRecording();  // Assuming startRecording is the function to start the mic recording
                            $('#generated-image').attr('src', '');
                            $('#generated-image').css({ 'width': '', 'height': '' });  // Reset the image size
                        }, 5000);  // = 5 seconds
                    });
                }, 10000);  // = 10 seconds
            }


            let mediaRecorder;
            let audioChunks = [];
            let audioContext;
            let isRecording = false;
            let silenceTimeout;

            let firstRecordingTime = null;
            let latestRecordingTime = null;


            let silenceTimeoutTime = 2000;
            let minimumRecordingDuration = 500;
            let maximumRecordingDuration = 10000;

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

                        const formData = new FormData();
                        formData.append('file', audioBlob);

                        // Send the recorded audio to the Django server
                        fetch('/process_audio/', {
                            method: 'POST',
                            body: formData,
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Transcription:', data.transcript);
                            generateImage(data.transcript); //directly generate image to reduce delay

                            const maxCharacters = 140;  // Change this to control the maximum number of characters
                            let transcript = data.transcript;
                            if (data.transcript.length > maxCharacters) {
                                transcript = data.transcript.substring(0, maxCharacters) + '...';
                            }
                            // // Update your UI with the transcription result
                            // $('#transcriptionText').text(data.transcript);

                            // onTranscriptionResultReady();
                            // //getGptContextPrompt(data.transcript);
                            // generateImage(data.transcript);
                            $('#mic_recording, #profanity-detected, #image-form, #loading-image, #generated-image').hide();
                            $('#transcriptionResult').show();

                            // Clear the transcriptionText element
                            $('#transcriptionText').text('');

                            // Show the transcription result one character at a time
                            let i = 0;
                            const speed = 80;  // Change this to control the speed
                            const intervalId = setInterval(() => {
                                if (i < transcript.length) {
                                    $('#transcriptionText').text($('#transcriptionText').text() + transcript[i]);
                                    i++;
                                } else {
                                    clearInterval(intervalId);
                                    onTranscriptionResultReady();                                    
                                }
                            }, speed);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });

                        // Stop all tracks in the stream
                        stream.getTracks().forEach(track => track.stop());
                    };

                    // Check microphone audio level continuously
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const analyser = audioContext.createAnalyser();
                    const microphone = audioContext.createMediaStreamSource(stream);
                    const scriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                    analyser.smoothingTimeConstant = 0.3;
                    analyser.fftSize = 1024;

                    microphone.connect(analyser);
                    analyser.connect(scriptNode);
                    scriptNode.connect(audioContext.destination);

                    scriptNode.onaudioprocess = function(event) {
                        const buffer = event.inputBuffer.getChannelData(0);
                        const maxAmplitude = Math.max.apply(null, buffer);

                        // Adjust this threshold based on your requirements
                        const turnOnThreshold = 0.7;
                        const silenceThreshold = 0.3;

                        console.log("maxAmplitude: " + maxAmplitude);

                        if (maxAmplitude > turnOnThreshold) {
                            if(isRecording == false){
                                audioChunks = []; //start recording now
                                isRecording = true;
                                $('#micIcon').show();
                                firstRecordingTime = Date.now();
                            }
                        }
                        if(maxAmplitude > silenceThreshold && isRecording){                            
                            latestRecordingTime = Date.now();
                            // Reset the silence timeout if the volume is high
                            clearTimeout(silenceTimeout);
                            silenceTimeout = undefined;
                            console.log("cleared timeout");
                        } else {
                            // Start the silence timeout if the volume is low
                            if (isRecording) {
                                const recordingDuration = latestRecordingTime - firstRecordingTime;
                                if (recordingDuration > minimumRecordingDuration && recordingDuration < maximumRecordingDuration) {
                                    console.log(silenceTimeout);
                                    if (typeof silenceTimeout == 'undefined') {
                                        console.log("started timeout");
                                        silenceTimeout = setTimeout(() => {                                        
                                            if (isRecording) {//send the data after a pause
                                                mediaRecorder.stop();
                                                isRecording = false;
                                                $('#micIcon').hide();
                                                silenceTimeout = undefined;
                                            }
                                        }, silenceTimeoutTime);//silence delay after which audio is sent
                                    }
                                } else if (recordingDuration > maximumRecordingDuration){                                    
                                    if (isRecording) {//send the data if someone speaks for too long
                                        mediaRecorder.stop();
                                        isRecording = false;
                                        $('#micIcon').hide();
                                        silenceTimeout = undefined;
                                        console.log("stopped recording because of max duration");
                                    }
                                }
                                else if (Date.now() - latestRecordingTime > silenceTimeoutTime) { //if recording too short or too long, reset
                                    isRecording = false;
                                    $('#micIcon').hide();                                    
                                }
                            }
                        }
                    };
                    
                    audioChunks = [];
                    mediaRecorder.start();
                } catch (error) {
                    console.error('Error starting recording:', error);
                }
            }

            document.getElementById('mic_recording').addEventListener('click', () => {
                // When the user clicks the mic_recording area, start recording
                startRecording();
            });

            //on page load, start recording
            startRecording();
        });
    </script>
</body>
</html>
